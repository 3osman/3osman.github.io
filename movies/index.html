<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
        <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <style>

        text {
            font: 10px sans-serif;
        }

        legend {
            width: 20%;
            float: right;
            margin-top: 0;
            padding-right: 40px;
            border: 0;
        }

        #chart {
            width: 75%;
            text-align: center;
            float: left;
        }

         .dark_red {fill: #A50026; background: #A50026;}
         .red { background-color: #F46D43; }
         .light_green { background-color: #A6D96A; }
         .green { background-color: #66BD63; }
         .dark_green { background-color: #006837; }

        legend > div {
            width: 24px;
            height: 24px;
        }

        legend > div::after {
            content: attr(data-category);
            display: inline-block;
            margin-left: 30px;
            line-height: 24px;
            width: 250px;
        }

        .btn {
            display: block;
            margin-bottom: 4px;

        }


    </style>
</head>
<body>
    <section id="chart"></section>

    <legend>
        Rating
            <div data-category="5 - 6" class="dark_red"></div>
            <div data-category="6 - 7" class="red"></div>
            <div data-category="7 - 8" class="light_green"></div>
            <div data-category="8 - 9" class="green"></div>
            <div data-category="9 - 10" class="dark_green"></div>


          </br>  Sort by
        <input type="button" class="btn btn-info" value="Rating" onclick="buildGraph(1);">
        <input type="button" class="btn btn-info" value="Number of Oscars" onclick="buildGraph(2);" >
        <input type="button" class="btn btn-info" value="Year" onclick="buildGraph(3);" >

        <input type="button" class="btn btn-info" value="Reset" onclick="buildGraph(0);">

        </br>
        <p>
        Bubble chart showing movies. One bubble represents a movie.
        </br> The size is relevant to the number of academy awards received. The color shows the user rating from IMDB.
        </p>
    </legend>    

    
    <script>
        buildGraph(0);

        function getToReturn(a, b, type) {
            toReturn = 0;
            if (type == 0) {
                toReturn = -1;

            } else if (type == 1) {
                
                    toReturn = a.whatever - b.whatever;

            } else if (type == 2) {
                if (a.value - b.value == 0)
                    toReturn = a.whatever - b.whatever;
                else
                    toReturn = a.value - b.value;

            }
            else if (type == 3) {
                toReturn = a.year - b.year;

            }
            return toReturn;
        }

        function buildGraph(type) {
         // svg =  document.getElementById("bubble");
         d3.select("svg").remove();
            var diameter = 700,
                    format = d3.format(",d"),
                    color = d3.scale.category20c();

            var bubble = d3.layout.pack()
    
                    .sort(function (a, b) {
                        return getToReturn(a, b, type);
                    })
                    .size([diameter, diameter])
                    .padding(1.5);
                              

            var svg = d3.select("#chart").append("svg")
                    .attr("width", diameter)
                    .attr("height", diameter)
                    .attr("id", "bubble");

            d3.json("https://api.myjson.com/bins/3kzqe", function (error, root)
            {
                var node = svg.selectAll(".node")
                        .data(bubble.nodes(classes(root))
                                .filter(function (d) {
                                    return !d.children;
                                }))
                        .enter().append("g")
                        .attr("class", "node")
                        .attr("transform", function (d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        });

                node.append("title").text(function (d, i) {
                    return "Title: " + d.className + "\n Oscars: " + d.value + "\n Average Rating: " + d.whatever + "/10\n" + "Year: " + d.year;
                });
                node.append("circle")
                        .attr("r", function (d) {
                            return d.r;
                        })
                        .style("fill", function (d)
                        {
                            
                            return d3.rgb(colorCircle(d.whatever)); // this gives a different color for every leaf node
                        });

                node.append("text")
                        .attr("dy", ".3em")
                        .style("text-anchor", "middle")
            });



        }
        function rgbToHex(col)
        {
            if (col.charAt(0) == 'r')
            {
                col = col.replace('rgb(', '').replace(')', '').split(',');
                var r = parseInt(col[0], 10).toString(16);
                var g = parseInt(col[1], 10).toString(16);
                var b = parseInt(col[2], 10).toString(16);
                r = r.length == 1 ? '0' + r : r;
                g = g.length == 1 ? '0' + g : g;
                b = b.length == 1 ? '0' + b : b;
                var colHex = '#' + r + g + b;

                return colHex;
            }
        }
        function colorCircle(val) {
            color = "";

            if (val >= 5 && val < 6) {
                color = rgbToHex("rgb(165, 0, 38)");
            } else if (val >= 6 && val < 7) {
                color = rgbToHex("rgb(244, 109, 67)");
            } else if (val >= 7 && val < 8) {
                color = rgbToHex("rgb(166, 217, 106)");
            } else if (val >= 8 && val < 9) {
                color = rgbToHex("rgb(102, 189, 99)");
            } else if (val >= 9 && val < 10) {
                color = rgbToHex("rgb(0, 104, 55)");
            }

            return color;
        }

        function classes(root) {
            var classes = [];

            function recurse(name, node) {
                if (node.children)
                    node.children.forEach(function (child) {
                        recurse(node.name, child);
                    });
                else
                    classes.push({packageName: name, className: node.title, value: node.oscar, whatever: node.rating.mean, year: node.year});
            }

            recurse(null, root);
            return {children: classes};
        }

    </script>
</body>
